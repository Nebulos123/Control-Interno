<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de V√≠as de Peaje v2.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GENERALES Y FONDO --- */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(-45deg, #2e3440, #3b4252, #434c5e, #4c566a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #eceff4;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Cambiado para que el contenido no siempre est√© centrado verticalmente */
            min-height: 100vh;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { max-width: 1400px; margin: 0 auto; width: 100%;}
        
        /* --- ESTILOS LOGIN --- */
        #login-container { background-color: #434c5e; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); width: 100%; max-width: 400px; text-align: center; margin-top: 10vh; }
        #login-container h1 { margin-top: 0; margin-bottom: 25px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #4c566a; background-color: #d8dee9; color: #2e3440; font-size: 1em; box-sizing: border-box; }
        #login-button { width: 100%; padding: 12px; background-color: #88c0d0; border: none; border-radius: 6px; color: #2e3440; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        #login-button:hover { background-color: #8fbcbb; }
        #login-button:disabled { background-color: #5e81ac; cursor: not-allowed; }
        #login-error { color: #bf616a; margin-top: 15px; font-weight: bold; display: none; }
        
        /* --- ESTILOS APP PRINCIPAL --- */
        header { background-color: rgba(46, 52, 64, 0.8); backdrop-filter: blur(5px); color: white; padding: 15px 20px; text-align: center; border-radius: 8px; margin-bottom: 25px; border-bottom: 4px solid #88c0d0; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.8em; }
        #user-info { display: flex; align-items: center; }
        #user-role-display { background-color: #88c0d0; color: #2e3440; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 15px; text-transform: uppercase; }
        #logout-button { background-color: #bf616a; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* --- [NUEVO] DASHBOARD DE ESTAD√çSTICAS --- */
        .dashboard-stats { display: flex; gap: 20px; margin-bottom: 25px; justify-content: space-around; }
        .stat-box { background-color: rgba(67, 76, 94, 0.8); padding: 20px; border-radius: 8px; text-align: center; flex-grow: 1; border-left: 5px solid #5e81ac; }
        .stat-box h3 { margin: 0 0 10px 0; font-size: 1em; color: #d8dee9; text-transform: uppercase; letter-spacing: 1px; }
        .stat-box .stat-number { font-size: 2.5em; font-weight: bold; color: #eceff4; }
        .stat-box#stat-problema .stat-number { color: #bf616a; }
        .stat-box#stat-revisar .stat-number { color: #ebcb8b; }
        .stat-box#stat-normal .stat-number { color: #a3be8c; }
        
        .controles-vias { background-color: rgba(67, 76, 94, 0.8); backdrop-filter: blur(5px); padding: 15px; margin-bottom: 25px; border-radius: 8px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .controles-vias input[type="search"] { flex-grow: 1; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #4c566a; background-color: #d8dee9; color: #2e3440; }
        .controles-vias .filter-buttons button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.2s; background-color: #4c566a; color: #eceff4; }
        .controles-vias .filter-buttons button.active { transform: scale(1.05); box-shadow: 0 0 10px rgba(136, 192, 208, 0.7); }
        
        .grupo-vias { position: relative; background-color: rgba(67, 76, 94, 0.8); backdrop-filter: blur(5px); border: 1px solid #4c566a; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.2); }
        .grupo-vias h2 { margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; color: #eceff4; font-size: 1.3em; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #5e81ac; }
        .vias-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 18px; }

        .via-box { position: relative; border-radius: 8px; padding: 18px 5px; text-align: center; font-size: 1.5em; font-weight: bold; cursor: pointer; color: #2e3440; border: 1px solid rgba(0, 0, 0, 0.2); border-bottom: 4px solid rgba(0, 0, 0, 0.4); text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3); transition: all 0.15s ease-out; }
        .via-box:hover { transform: translateY(-4px); filter: brightness(1.1); border-bottom-width: 6px; }
        .via-box.con-novedad::after { content: ''; position: absolute; top: 6px; right: 6px; width: 12px; height: 12px; background-color: white; border-radius: 50%; border: 2px solid #2e3440; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        
        .status-normal { background: linear-gradient(to bottom, #b2d89b, #a3be8c); }
        .status-revisar { background: linear-gradient(to bottom, #f0d899, #ebcb8b); }
        .status-problema { background: linear-gradient(to bottom, #c97c84, #bf616a); }

        /* --- [NUEVO] MENSAJE "SIN RESULTADOS" --- */
        .no-results-message { display: none; text-align: center; padding: 20px; font-style: italic; color: #d8dee9; }

        .grupos-secundarios-container { display: flex; gap: 25px; justify-content: space-between; margin-bottom: 25px; }
        .grupos-secundarios-container .grupo-vias { flex-grow: 1; margin-bottom: 0; }

        /* --- ESTILOS MODAL Y MEJORAS --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #eceff4; color: #2e3440; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        .historial-filtros { display: flex; gap: 10px; margin-bottom: 15px; }
        #historial-search { flex-grow: 1; padding: 8px; border: 1px solid #4c566a; border-radius: 4px; background-color: #fff; }
        #historial-date-picker { padding: 8px; border: 1px solid #4c566a; border-radius: 4px; background-color: #fff; }
        #historial-novedades-container { min-height: 150px; /* Para que el spinner se vea bien */ max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #d8dee9; border-radius: 5px; padding: 10px; position: relative; }
        #historial-novedades li { background-color: #d8dee9; margin-bottom: 10px; padding: 10px; border-radius: 5px; border-left: 4px solid #5e81ac; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .novedad-contenido { flex-grow: 1; }
        .meta-info { display: block; font-size: 0.8em; color: #4c566a; margin-bottom: 5px; }
        .novedad-acciones button { background: none; border: none; cursor: pointer; padding: 5px; font-size: 0.9em; border-radius: 4px; transition: background-color 0.2s; }
        .btn-editar { color: #5e81ac; } .btn-eliminar { color: #bf616a; }

        /* --- [NUEVO] PAGINACI√ìN DEL HISTORIAL --- */
        .pagination-controls { text-align: center; margin-top: 15px; }
        .pagination-controls button { background-color: #5e81ac; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin: 0 5px; }
        .pagination-controls button:disabled { background-color: #4c566a; cursor: not-allowed; }
        .pagination-controls span { margin: 0 10px; font-weight: bold; }

        /* --- [NUEVO] NOTIFICACIONES "TOAST" --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background-color: #4c566a; color: #eceff4; padding: 15px; border-radius: 5px; margin-bottom: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.5s ease; border-left: 5px solid #88c0d0; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { border-left-color: #bf616a; }
        
        /* --- [NUEVO] INDICADOR DE CARGA (SPINNER) --- */
        .loader-container { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(46, 52, 64, 0.7); z-index: 10; justify-content: center; align-items: center; border-radius: 12px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #88c0d0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Contenedor Login -->
    <div id="login-container"><h1>Iniciar Sesi√≥n</h1><form id="login-form"><div class="input-group"><label for="email">Usuario (Email)</label><input type="email" id="email" required></div><div class="input-group"><label for="password">Contrase√±a</label><input type="password" id="password" required></div><button type="submit" id="login-button">Acceder</button><p id="login-error">Usuario o contrase√±a incorrectos.</p></form></div>

    <!-- Contenido Principal -->
    <div id="main-content" style="display: none; width: 100%;">
        <header>
            <h1>Sistema de Control y Novedades de V√≠as</h1>
            <div id="user-info">
                <span id="user-email-display" style="margin-right: 15px; font-style: italic;"></span>
                <span id="user-role-display"></span>
                <button id="logout-button">Cerrar Sesi√≥n</button>
            </div>
        </header>
        <main class="container">
            <!-- [NUEVO] Dashboard de Estad√≠sticas -->
            <div class="dashboard-stats">
                <div class="stat-box" id="stat-problema"><h3>Con Problema</h3><div class="stat-number" id="stat-count-problema">0</div></div>
                <div class="stat-box" id="stat-revisar"><h3>Para Revisar</h3><div class="stat-number" id="stat-count-revisar">0</div></div>
                <div class="stat-box" id="stat-normal"><h3>Normales</h3><div class="stat-number" id="stat-count-normal">0</div></div>
            </div>

            <div class="controles-vias">
                <input type="search" id="search-box" placeholder="Buscar por n√∫mero de v√≠a...">
                <div class="filter-buttons">
                    <button id="filter-todos" class="active">Todos</button>
                    <button id="filter-normal">Normal</button>
                    <button id="filter-revisar">Revisar</button>
                    <button id="filter-problema">Problema</button>
                </div>
            </div>
            
            <div class="grupo-vias" id="container-1-40">
                <div class="loader-container"><div class="spinner"></div></div>
                <h2>RICCHERI (V√≠as 1 - 40)</h2>
                <div id="grupo-1-40" class="vias-grid"></div>
                <p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p>
            </div>

            <div class="grupos-secundarios-container">
                <div class="grupo-vias" id="container-43-44">
                    <div class="loader-container"><div class="spinner"></div></div>
                    <h2>DONOVAN (V√≠as 43 - 44)</h2>
                    <div id="grupo-43-44" class="vias-grid"></div>
                    <p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p>
                </div>
                <div class="grupo-vias" id="container-46-47">
                    <div class="loader-container"><div class="spinner"></div></div>
                    <h2>BOULOGNE SUR MER (V√≠as 46 - 47)</h2>
                    <div id="grupo-46-47" class="vias-grid"></div>
                    <p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p>
                </div>
                <div class="grupo-vias" id="container-50-51">
                    <div class="loader-container"><div class="spinner"></div></div>
                    <h2>MERCADO CENTRAL (V√≠as 50 - 51)</h2>
                    <div id="grupo-50-51" class="vias-grid"></div>
                    <p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal con mejoras -->
    <div id="modal-via" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span><h2 id="modal-title"></h2>
            <div class="modal-body">
                <div class="historial-section">
                    <h3>Historial</h3>
                    <div class="historial-filtros">
                        <input type="search" id="historial-search" placeholder="Buscar en el historial...">
                        <input type="date" id="historial-date-picker">
                    </div>
                    <div id="historial-novedades-container">
                        <div class="loader-container" id="historial-loader"><div class="spinner"></div></div>
                        <ul id="historial-novedades" style="list-style-type: none; padding: 0;"></ul>
                    </div>
                    <!-- [NUEVO] Controles de Paginaci√≥n -->
                    <div id="historial-pagination" class="pagination-controls"></div>
                </div>
                <div class="form-section"><h3>Agregar/Modificar</h3><form id="form-novedad"><input type="hidden" id="via-id-input"><label for="descripcion-novedad">Novedad:</label><textarea id="descripcion-novedad" rows="4" placeholder="Opcional."></textarea><label for="status-via">Estado:</label><select id="status-via"><option value="normal">Normal (Verde)</option><option value="revisar">Revisar (Amarillo)</option><option value="problema">Problema (Rojo)</option></select><button type="submit">Guardar</button></form></div>
            </div>
        </div>
    </div>
    
    <!-- [NUEVO] Contenedor para notificaciones Toast -->
    <div id="toast-container"></div>

    <script>
        // --- Configuraci√≥n y Elementos DOM ---
        const SUPABASE_URL = 'https://ybrwwgkouxdgdfpdofin.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlicnd3Z2tvdXhkZ2RmcGRvZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjU3MzksImV4cCI6MjA3NTEwMTczOX0.oxBJ8P1lyu8fL6eSFYRatCiP4XRg2xtdUJa8pqjNvxo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Elementos DOM
        const loginContainer = document.getElementById('login-container'), mainContent = document.getElementById('main-content'), loginForm = document.getElementById('login-form'), loginButton = document.getElementById('login-button'), loginError = document.getElementById('login-error'), logoutButton = document.getElementById('logout-button'), userEmailDisplay = document.getElementById('user-email-display'), userRoleDisplay = document.getElementById('user-role-display'), modal = document.getElementById('modal-via'), closeButton = document.querySelector('.close-button'), formNovedad = document.getElementById('form-novedad'), searchBox = document.getElementById('search-box'), filterButtons = document.querySelectorAll('.filter-buttons button'), historialSearch = document.getElementById('historial-search'), historialDatePicker = document.getElementById('historial-date-picker');
        const gruposContenedores = { 'grupo-1-40': document.getElementById('grupo-1-40'), 'grupo-43-44': document.getElementById('grupo-43-44'), 'grupo-46-47': document.getElementById('grupo-46-47'), 'grupo-50-51': document.getElementById('grupo-50-51') };
        
        // Estado de la aplicaci√≥n
        let currentUserEmail = null;
        let currentUserRole = 'operator'; // Rol por defecto
        let filtroActivo = 'todos';
        let canalVias = null;
        let todasLasVias = []; // Cache local de las v√≠as para el dashboard
        let viaActualModal = null; // Para la paginaci√≥n

        // --- [NUEVA FUNCI√ìN] Notificaciones Toast ---
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.textContent = mensaje;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- [MEJORADA] Funciones de Carga con Spinners ---
        async function cargarVias() {
            document.querySelectorAll('.loader-container').forEach(loader => loader.style.display = 'flex');
            try {
                const { data: vias, error } = await supabase.from('vias_con_novedades_info').select('*').order('numero_via', { ascending: true });
                if (error) throw error;
                todasLasVias = vias; // Guardar en cache
                Object.values(gruposContenedores).forEach(container => container.innerHTML = '');
                vias.forEach(via => {
                    const viaBox = document.createElement('div');
                    viaBox.className = `via-box status-${via.status}`;
                    viaBox.textContent = via.numero_via;
                    viaBox.dataset.viaId = via.id;
                    viaBox.dataset.viaStatus = via.status;
                    if (via.tiene_novedades) viaBox.classList.add('con-novedad');
                    viaBox.addEventListener('click', () => mostrarModal(via));
                    if (via.numero_via <= 40) gruposContenedores['grupo-1-40'].appendChild(viaBox);
                    else if (via.numero_via <= 44) gruposContenedores['grupo-43-44'].appendChild(viaBox);
                    else if (via.numero_via <= 47) gruposContenedores['grupo-46-47'].appendChild(viaBox);
                    else if (via.numero_via <= 51) gruposContenedores['grupo-50-51'].appendChild(viaBox);
                });
                actualizarDashboard();
                filtrarVias();
            } catch (error) {
                console.error('Error al cargar las v√≠as:', error);
                mostrarNotificacion('No se pudieron cargar los datos.', 'error');
            } finally {
                document.querySelectorAll('.grupo-vias .loader-container').forEach(loader => loader.style.display = 'none');
            }
        }

        // --- [NUEVA FUNCI√ìN] Dashboard ---
        function actualizarDashboard() {
            const counts = todasLasVias.reduce((acc, via) => {
                acc[via.status] = (acc[via.status] || 0) + 1;
                return acc;
            }, {});
            document.getElementById('stat-count-problema').textContent = counts.problema || 0;
            document.getElementById('stat-count-revisar').textContent = counts.revisar || 0;
            document.getElementById('stat-count-normal').textContent = counts.normal || 0;
        }

        // --- [MEJORADA] Modal y Paginaci√≥n del Historial ---
        async function mostrarModal(via) {
            viaActualModal = via;
            document.getElementById('modal-title').textContent = `Detalles - V√≠a ${via.numero_via}`;
            document.getElementById('via-id-input').value = via.id;
            document.getElementById('status-via').value = via.status;
            document.getElementById('descripcion-novedad').value = '';
            historialSearch.value = '';
            historialDatePicker.value = '';
            modal.style.display = 'block';
            await cargarHistorialPaginado(1);
        }

        async function cargarHistorialPaginado(page) {
            const NOVEDADES_PER_PAGE = 5;
            const from = (page - 1) * NOVEDADES_PER_PAGE;
            const to = from + NOVEDADES_PER_PAGE - 1;

            const historialLista = document.getElementById('historial-novedades');
            const loader = document.getElementById('historial-loader');
            loader.style.display = 'flex';
            historialLista.innerHTML = '';
            
            try {
                // Obtener el total para la paginaci√≥n
                const { count, error: countError } = await supabase.from('novedades').select('*', { count: 'exact', head: true }).eq('via_id', viaActualModal.id);
                if (countError) throw countError;

                const { data: novedades, error } = await supabase.from('novedades').select('*').eq('via_id', viaActualModal.id).order('created_at', { ascending: false }).range(from, to);
                if (error) throw error;
                
                if (novedades.length > 0) {
                    novedades.forEach(novedad => {
                        const item = document.createElement('li');
                        item.dataset.novedadId = novedad.id;
                        item.dataset.fecha = novedad.created_at;
                        const fechaLocal = new Date(novedad.created_at).toLocaleString('es-AR');
                        const esPropietario = novedad.user_email === currentUserEmail;
                        const puedeModificar = esPropietario || currentUserRole === 'admin';
                        item.innerHTML = `
                            <div class="novedad-contenido">
                                <span class="meta-info"><span class="fecha">${fechaLocal}</span> - <span class="usuario">${novedad.user_email || 'Sistema'}</span></span>
                                <p class="descripcion-texto">${novedad.descripcion}</p>
                            </div>
                            ${puedeModificar ? `<div class="novedad-acciones"><button class="btn-editar" title="Editar">‚úèÔ∏è</button><button class="btn-eliminar" title="Eliminar">üóëÔ∏è</button></div>` : ''}`;
                        historialLista.appendChild(item);
                    });
                } else { 
                    historialLista.innerHTML = '<li>Sin novedades.</li>'; 
                }
                
                renderizarControlesPaginacion(page, count, NOVEDADES_PER_PAGE);
            } catch (error) {
                console.error("Error cargando historial:", error);
                historialLista.innerHTML = '<li>Error al cargar.</li>';
            } finally {
                loader.style.display = 'none';
            }
        }
        
        function renderizarControlesPaginacion(currentPage, totalItems, perPage) {
            const paginationContainer = document.getElementById('historial-pagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalItems / perPage);
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => cargarHistorialPaginado(currentPage - 1);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Siguiente';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => cargarHistorialPaginado(currentPage + 1);

            paginationContainer.append(prevButton, pageInfo, nextButton);
        }


        function filtrarHistorial() {
            // Esta funci√≥n ahora ser√≠a m√°s compleja con paginaci√≥n.
            // Por simplicidad, la dejaremos como est√°, pero ten en cuenta que solo filtrar√° la p√°gina actual.
            // Una implementaci√≥n avanzada requerir√≠a volver a consultar a Supabase con los filtros.
            const searchTerm = historialSearch.value.toLowerCase();
            const selectedDate = historialDatePicker.value;
            const novedades = document.querySelectorAll('#historial-novedades li');
            
            novedades.forEach(novedad => {
                const textoNovedad = novedad.querySelector('.novedad-contenido')?.innerText.toLowerCase() || '';
                const fechaNovedad = novedad.dataset.fecha || '';
                const coincideTexto = textoNovedad.includes(searchTerm);
                const coincideFecha = !selectedDate || fechaNovedad.startsWith(selectedDate);
                
                if (coincideTexto && coincideFecha) {
                    novedad.style.display = 'flex';
                } else {
                    novedad.style.display = 'none';
                }
            });
        }
        historialSearch.addEventListener('input', filtrarHistorial);
        historialDatePicker.addEventListener('change', filtrarHistorial);

        // --- [MEJORADA] Autenticaci√≥n y Roles ---
        const handleLogin = async (event) => {
            event.preventDefault();
            loginButton.disabled = true;
            loginButton.textContent = 'Accediendo...';
            loginError.style.display = 'none';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                // Obtener el rol del usuario
                const { data: profile, error: profileError } = await supabase.from('profiles').select('role').eq('id', data.user.id).single();
                if (profileError) throw profileError;
                
                loginContainer.style.display = 'none';
                mainContent.style.display = 'block';
                currentUserEmail = data.user.email;
                currentUserRole = profile.role || 'operator';
                userEmailDisplay.textContent = currentUserEmail;
                userRoleDisplay.textContent = currentUserRole;
                await cargarVias();
                escucharCambiosVias();

            } catch(error) {
                console.error('Error de login:', error.message);
                loginError.style.display = 'block';
                mostrarNotificacion('Usuario o contrase√±a incorrectos.', 'error');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Acceder';
            }
        };

        const checkUser = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                const { data: profile, error: profileError } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
                if (profileError) { console.error("Error obteniendo perfil"); await handleLogout(); return; }

                loginContainer.style.display = 'none';
                mainContent.style.display = 'block';
                currentUserEmail = session.user.email;
                currentUserRole = profile.role || 'operator';
                userEmailDisplay.textContent = currentUserEmail;
                userRoleDisplay.textContent = currentUserRole;
                await cargarVias();
                escucharCambiosVias();
            } else {
                loginContainer.style.display = 'block';
                mainContent.style.display = 'none';
            }
        };

        const handleLogout = async () => { if (canalVias) { supabase.removeChannel(canalVias); canalVias = null; } await supabase.auth.signOut(); mainContent.style.display = 'none'; loginContainer.style.display = 'block'; document.getElementById('email').value = ''; document.getElementById('password').value = ''; userEmailDisplay.textContent = ''; userRoleDisplay.textContent = ''; currentUserEmail = null; currentUserRole = 'operator'; };

        function cerrarModal() { modal.style.display = 'none'; viaActualModal = null; }
        
        async function manejarSubmitNovedad(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Guardando...';
            try {
                const idVia = document.getElementById('via-id-input').value;
                const nuevaDescripcion = document.getElementById('descripcion-novedad').value.trim();
                const nuevoStatus = document.getElementById('status-via').value;
                const viaBox = document.querySelector(`.via-box[data-via-id='${idVia}']`);
                const statusOriginal = viaBox ? viaBox.dataset.viaStatus : null;
                if (!nuevaDescripcion && nuevoStatus === statusOriginal) { cerrarModal(); return; }
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { mostrarNotificacion('Sesi√≥n expirada. Inicie sesi√≥n de nuevo.', 'error'); return; }
                
                const promises = [];
                if (nuevaDescripcion) { promises.push(supabase.from('novedades').insert([{ via_id: idVia, descripcion: nuevaDescripcion, user_email: user.email }])); }
                if (nuevoStatus !== statusOriginal) { promises.push(supabase.from('vias').update({ status: nuevoStatus }).eq('id', idVia)); }
                
                const results = await Promise.all(promises);
                if (results.some(r => r.error)) { throw new Error('Error al guardar datos en Supabase'); }
                
                mostrarNotificacion('Guardado con √©xito!');
                cerrarModal();
            } catch (error) {
                console.error('Error al guardar:', error);
                mostrarNotificacion('Error al guardar la novedad.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Guardar';
            }
        }
        
        // --- [MEJORADA] Filtrado con mensaje "Sin Resultados" ---
        function filtrarVias() {
            const textoBusqueda = searchBox.value.toLowerCase();
            document.querySelectorAll('.grupo-vias').forEach(grupo => {
                let viasVisibles = 0;
                const viasEnGrupo = grupo.querySelectorAll('.via-box');
                viasEnGrupo.forEach(via => {
                    const coincideBusqueda = via.textContent.includes(textoBusqueda);
                    const coincideFiltro = (filtroActivo === 'todos') || (via.dataset.viaStatus === filtroActivo);
                    if (coincideBusqueda && coincideFiltro) {
                        via.style.display = 'block';
                        viasVisibles++;
                    } else {
                        via.style.display = 'none';
                    }
                });
                
                const mensajeVacio = grupo.querySelector('.no-results-message');
                if (viasVisibles === 0) {
                    mensajeVacio.style.display = 'block';
                } else {
                    mensajeVacio.style.display = 'none';
                }
            });
        }
        
        function escucharCambiosVias() {
            if (canalVias) return;
            canalVias = supabase.channel('cambios-db-vias')
                .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
                    console.log('Cambio recibido en tiempo real:', payload);
                    if(payload.table === 'vias' || payload.table === 'novedades') {
                       cargarVias();
                    }
                })
                .subscribe();
            console.log("Suscrito a cambios en tiempo real.");
        }
        
        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        document.addEventListener('DOMContentLoaded', checkUser);
        closeButton.addEventListener('click', cerrarModal);
        window.addEventListener('click', (event) => { if (event.target == modal) { cerrarModal(); } });
        formNovedad.addEventListener('submit', manejarSubmitNovedad);
        searchBox.addEventListener('input', filtrarVias);
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                filtroActivo = button.id.replace('filter-', '');
                filtrarVias();
            });
        });
        document.getElementById('historial-novedades').addEventListener('click', async (e) => {
            const target = e.target;
            const itemLi = target.closest('li');
            if (!itemLi) return;
            if (target.classList.contains('btn-eliminar')) {
                if (confirm("¬øEst√° seguro de que desea eliminar esta novedad?")) {
                    const { error } = await supabase.from('novedades').delete().eq('id', itemLi.dataset.novedadId);
                    if (error) mostrarNotificacion("Error al eliminar", 'error');
                    else {
                        mostrarNotificacion("Novedad eliminada.");
                        cargarHistorialPaginado(1); // Recargar la p√°gina actual del historial
                    }
                }
            } // El resto de la l√≥gica para editar/guardar/cancelar puede ir aqu√≠ si la necesitas.
        });
    </script>
</body>
</html>
