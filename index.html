<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL DE CITRINO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GENERALES Y FONDO --- */
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(-45deg, #2e3440, #3b4252, #434c5e, #4c566a); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #eceff4; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { max-width: 1400px; margin: 0 auto; width: 100%;}
        
        /* --- ESTILOS LOGIN --- */
        #login-container { background-color: #434c5e; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); width: 100%; max-width: 400px; text-align: center; margin-top: 10vh; }
        #login-container h1 { margin-top: 0; margin-bottom: 25px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #4c566a; background-color: #d8dee9; color: #2e3440; font-size: 1em; box-sizing: border-box; }
        #login-button { width: 100%; padding: 12px; background-color: #88c0d0; border: none; border-radius: 6px; color: #2e3440; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        #login-button:hover { background-color: #8fbcbb; }
        #login-button:disabled { background-color: #5e81ac; cursor: not-allowed; }
        #login-error { color: #bf616a; margin-top: 15px; font-weight: bold; display: none; }
        
        /* --- ESTILOS APP PRINCIPAL --- */
        header { background-color: rgba(46, 52, 64, 0.8); backdrop-filter: blur(5px); color: white; padding: 15px 20px; text-align: center; border-radius: 8px; margin-bottom: 25px; border-bottom: 4px solid #88c0d0; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.8em; }
        #user-info { display: flex; align-items: center; }
        #user-role-display { background-color: #88c0d0; color: #2e3440; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 15px; text-transform: uppercase; }
        #logout-button { background-color: #bf616a; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* --- DASHBOARD DE ESTAD√çSTICAS --- */
        .dashboard-stats { display: flex; gap: 20px; margin-bottom: 25px; justify-content: space-around; }
        .stat-box { background-color: rgba(67, 76, 94, 0.8); padding: 20px; border-radius: 8px; text-align: center; flex-grow: 1; border-left: 5px solid #5e81ac; }
        .stat-box h3 { margin: 0 0 10px 0; font-size: 1em; color: #d8dee9; text-transform: uppercase; letter-spacing: 1px; }
        .stat-box .stat-number { font-size: 2.5em; font-weight: bold; color: #eceff4; }
        .stat-box#stat-problema .stat-number { color: #bf616a; }
        .stat-box#stat-revisar .stat-number { color: #ebcb8b; }
        .stat-box#stat-normal .stat-number { color: #a3be8c; }
        
        .controles-vias { background-color: rgba(67, 76, 94, 0.8); backdrop-filter: blur(5px); padding: 15px; margin-bottom: 25px; border-radius: 8px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .controles-vias input[type="search"] { flex-grow: 1; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #4c566a; background-color: #d8dee9; color: #2e3440; }
        .controles-vias .filter-buttons button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.2s; background-color: #4c566a; color: #eceff4; }
        .controles-vias .filter-buttons button.active { transform: scale(1.05); box-shadow: 0 0 10px rgba(136, 192, 208, 0.7); }
        
        .grupo-vias { position: relative; background-color: rgba(67, 76, 94, 0.8); backdrop-filter: blur(5px); border: 1px solid #4c566a; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.2); }
        .grupo-vias h2 { margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; color: #eceff4; font-size: 1.3em; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #5e81ac; }
        .vias-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 18px; }

        .via-box { 
            position: relative; border-radius: 8px; padding: 18px 5px 30px 5px; text-align: center; font-size: 1.5em; font-weight: bold; cursor: pointer; color: #2e3440; border: 1px solid rgba(0, 0, 0, 0.2); border-bottom: 4px solid rgba(0, 0, 0, 0.4); text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3); transition: all 0.15s ease-out; box-sizing: border-box;
        }
        .via-box:hover { transform: translateY(-4px); filter: brightness(1.1); border-bottom-width: 6px; }
        
        .status-normal { background: linear-gradient(to bottom, #b2d89b, #a3be8c); }
        .status-revisar { background: linear-gradient(to bottom, #f0d899, #ebcb8b); }
        .status-problema { background: linear-gradient(to bottom, #c97c84, #bf616a); }
        
        .barrera-info { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 4px; background-color: rgba(46, 52, 64, 0.7); padding: 2px 6px; border-radius: 4px; line-height: 1; }
        .barrera-info .barrera-icono { width: 14px; height: 14px; fill: #d8dee9; }
        .barrera-info .barrera-modelo-nombre { font-size: 9px; color: #eceff4; font-weight: normal; }

        .no-results-message { display: none; text-align: center; padding: 20px; font-style: italic; color: #d8dee9; }
        .grupos-secundarios-container { display: flex; gap: 25px; justify-content: space-between; margin-bottom: 25px; }
        .grupos-secundarios-container .grupo-vias { flex-grow: 1; margin-bottom: 0; }
        
        #tooltip-problema { position: absolute; padding: 10px 15px; border-radius: 6px; z-index: 1001; pointer-events: none; opacity: 0; font-size: 0.9em; max-width: 250px; text-align: left; box-shadow: 0 3px 8px rgba(0,0,0,0.3); transition: opacity 0.2s ease-in-out; }
        #tooltip-problema.visible { opacity: 1; }
        #tooltip-problema strong { display: block; margin-bottom: 5px; padding-bottom: 5px; }
        #tooltip-problema.tooltip-problema { background-color: #bf616a; color: #eceff4; }
        #tooltip-problema.tooltip-problema strong { border-bottom: 1px solid rgba(236, 239, 244, 0.5); }
        #tooltip-problema.tooltip-revisar { background-color: #ebcb8b; color: #2e3440; }
        #tooltip-problema.tooltip-revisar strong { border-bottom: 1px solid rgba(46, 52, 64, 0.5); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #eceff4; color: #2e3440; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { display: flex; flex-direction: column; gap: 25px; }
        .tasks-section { flex: 2; }
        .form-section { flex: 1; }
        .modal-tabs { display: flex; border-bottom: 2px solid #d8dee9; margin-bottom: 15px; }
        .modal-tabs button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; font-weight: bold; color: #4c566a; border-bottom: 3px solid transparent; }
        .modal-tabs button.active { color: #5e81ac; border-bottom-color: #5e81ac; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .novedades-container { min-height: 150px; max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #d8dee9; border-radius: 5px; padding: 10px; position: relative; }
        .novedades-container li { background-color: #d8dee9; margin-bottom: 10px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .novedad-pendiente { border-left: 5px solid #ebcb8b; }
        .novedad-resuelta { border-left: 5px solid #a3be8c; }
        .novedad-contenido { flex-grow: 1; word-break: break-word; }
        .meta-info { display: block; font-size: 0.8em; color: #4c566a; margin-bottom: 5px; }
        .meta-info.resuelta-info { color: #a3be8c; font-weight: bold; margin-top: 4px; }
        .novedad-acciones button { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.2em; border-radius: 4px; transition: transform 0.1s; }
        .novedad-acciones button:hover { transform: scale(1.2); }
        .btn-resolver { color: #a3be8c; font-weight: bold; }
        .btn-editar { color: #5e81ac; }
        .btn-eliminar { color: #bf616a; }
        .edit-container { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .edit-textarea { width: 100%; box-sizing: border-box; min-height: 60px; font-family: 'Roboto', sans-serif; font-size: 0.9em; padding: 5px; border-radius: 4px; border: 1px solid #5e81ac; }
        .edit-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .edit-actions button { font-size: 0.8em; padding: 5px 10px; border-radius: 4px; color: white; cursor: pointer; border: none;}
        .btn-guardar-edicion { background-color: #a3be8c; }
        .btn-cancelar-edicion { background-color: #d08770; }
        .historial-filtros { display: flex; gap: 10px; margin-bottom: 15px; }
        #historial-search { flex-grow: 1; padding: 8px; border: 1px solid #4c566a; border-radius: 4px; }
        #historial-date-picker { padding: 8px; border: 1px solid #4c566a; border-radius: 4px; }
        .pagination-controls { text-align: center; margin-top: 15px; }
        .pagination-controls button { background-color: #5e81ac; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin: 0 5px; }
        .pagination-controls button:disabled { background-color: #4c566a; cursor: not-allowed; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background-color: #4c566a; color: #eceff4; padding: 15px; border-radius: 5px; margin-bottom: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.5s ease; border-left: 5px solid #88c0d0; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { border-left-color: #bf616a; }
        .loader-container { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(46, 52, 64, 0.7); z-index: 10; justify-content: center; align-items: center; border-radius: 12px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #88c0d0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #page-footer { width: 100%; max-width: 1400px; margin: 40px auto 20px auto; border-top: 1px solid #4c566a; text-align: center; padding-top: 20px; }
        .neon-text { font-size: 1.2em; font-weight: bold; color: #fff; text-shadow: 0 0 7px #fff, 0 0 10px #fff, 0 0 21px #fff, 0 0 42px #88c0d0, 0 0 82px #88c0d0, 0 0 92px #88c0d0, 0 0 102px #88c0d0, 0 0 151px #88c0d0; animation: neon-flicker 2s infinite alternate; }
        @keyframes neon-flicker { 0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 4px #fff, 0 0 11px #fff, 0 0 19px #fff, 0 0 40px #88c0d0, 0 0 80px #88c0d0, 0 0 90px #88c0d0, 0 0 100px #88c0d0, 0 0 150px #88c0d0; } 20%, 24%, 55% { text-shadow: none; } }

        .busqueda-global-container { background-color: rgba(46, 52, 64, 0.8); backdrop-filter: blur(5px); padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 100%; }
        .busqueda-global-input { display: flex; gap: 10px; margin-bottom: 20px; }
        .busqueda-global-input input { flex-grow: 1; padding: 12px; font-size: 1em; border-radius: 5px; border: 1px solid #4c566a; background-color: #d8dee9; color: #2e3440; }
        .busqueda-global-input button { padding: 12px 20px; background-color: #88c0d0; border: none; border-radius: 5px; color: #2e3440; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .busqueda-global-input button:hover { background-color: #8fbcbb; }
        #global-search-results-container h3 { margin-top: 0; border-bottom: 2px solid #5e81ac; padding-bottom: 10px; margin-bottom: 15px; }
        #global-search-results-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #global-search-results-list li { background-color: #4c566a; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 5px solid #88c0d0; }
        .resultado-via-numero { font-weight: bold; font-size: 1.2em; color: #eceff4; background-color: #5e81ac; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-right: 15px; }
        .resultado-descripcion { margin: 10px 0 0 0; color: #d8dee9; }
        .resultado-meta { font-size: 0.8em; color: #a3be8c; margin-top: 10px; display: block; }
        .resultado-meta .fecha { color: #d8dee9; font-style: italic; }
        .estado-tag { font-size: 0.8em; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #2e3440; background-color: #ebcb8b; }
        .estado-tag.resuelta { background-color: #a3be8c; }
        .form-section { padding: 15px; border: 1px solid #d8dee9; border-radius: 6px; background-color: #e5e9f0; }
        .form-section h3 { margin-top: 0; }
        .form-section label { font-size: 1.1em; margin-bottom: 8px; }
        .form-section textarea, .form-section select, .form-section button, .form-section input { font-size: 1em; padding: 10px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        #descripcion-novedad { min-height: 120px; }
        .form-section button[type="submit"] { font-size: 1.1em; font-weight: bold; }

        #poroto-jar-container { position: fixed; bottom: 20px; right: 20px; width: 150px; text-align: center; z-index: 2000; }
        #poroto-jar { width: 100px; height: 120px; background: rgba(216, 222, 233, 0.2); border: 3px solid #d8dee9; border-radius: 5px 5px 25px 25px; margin: 0 auto; position: relative; box-shadow: inset 0 0 15px rgba(0,0,0,0.3); display: flex; align-items: flex-end; }
        #poroto-jar::before { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 80px; height: 10px; background-color: #4c566a; border: 3px solid #d8dee9; border-radius: 5px; }
        #porotos-container { width: 100%; height: 100%; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 20px; gap: 2px; padding: 5px; box-sizing: border-box; align-content: end; }
        .poroto { width: 18px; height: 15px; background: linear-gradient(135deg, #c3a17a, #8e6f4d); border-radius: 50%; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); animation: poroto-fall 0.5s ease-out; justify-self: center; }
        #poroto-counter { background-color: rgba(46, 52, 64, 0.8); color: #eceff4; padding: 5px 10px; border-radius: 5px; margin-top: 15px; font-weight: bold; border: 1px solid #4c566a; }
        @keyframes poroto-fall { from { transform: translateY(-120px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .jar-full-animation { animation: jar-shake 0.5s ease-in-out; }
        @keyframes jar-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-2deg); } 75% { transform: translateX(5px) rotate(2deg); } }
        .poroto-exit { animation: poroto-fade-out 0.5s ease-in forwards; }
        @keyframes poroto-fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0); } }

        /* <!-- NUEVO: Estilos para panel de admin de tareas predeterminadas --> */
        #preset-tasks-list li {
            background-color: #4c566a;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #88c0d0;
        }
        #preset-tasks-list button {
            background-color: #bf616a;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

    </style>
</head>
<body>
    <div id="login-container"><h1>Iniciar Sesi√≥n</h1><form id="login-form"><div class="input-group"><label for="email">Usuario (Email)</label><input type="email" id="email" required></div><div class="input-group"><label for="password">Contrase√±a</label><input type="password" id="password" required></div><button type="submit" id="login-button">Acceder</button><p id="login-error">Usuario o contrase√±a incorrectos.</p></form></div>
    
    <div id="main-content" style="display: none; width: 100%;">
        <header><h1>CONTROL INTERNO SISTEMAS</h1><div id="user-info"><span id="user-email-display" style="margin-right: 15px; font-style: italic;"></span><span id="user-role-display"></span><button id="logout-button">Cerrar Sesi√≥n</button></div></header>
        <main class="container">
            <div class="dashboard-stats"><div class="stat-box" id="stat-problema"><h3>Con Problema</h3><div class="stat-number" id="stat-count-problema">0</div></div><div class="stat-box" id="stat-revisar"><h3>Para Revisar</h3><div class="stat-number" id="stat-count-revisar">0</div></div><div class="stat-box" id="stat-normal"><h3>Normales</h3><div class="stat-number" id="stat-count-normal">0</div></div></div>
            <div class="controles-vias"><input type="search" id="search-box" placeholder="Buscar por n√∫mero de v√≠a..."><div class="filter-buttons"><button id="filter-todos" class="active">Todos</button><button id="filter-normal">Normal</button><button id="filter-revisar">Revisar</button><button id="filter-problema">Problema</button></div></div>
            <div class="busqueda-global-container"><div class="busqueda-global-input"><input type="search" id="global-search-box" placeholder="Buscar problema en todas las v√≠as (ej: Contactor, Barrera...)"><button id="global-search-button">Buscar</button></div><div id="global-search-results-container" style="display: none;"><h3>Resultados de la B√∫squeda</h3><div class="loader-container" id="global-search-loader" style="display: none;"><div class="spinner"></div></div><ul id="global-search-results-list"></ul><p id="no-global-results-message" style="display: none;">No se encontraron resultados para tu b√∫squeda.</p></div></div>
            
            <!-- NUEVO: Contenedor para gesti√≥n de tareas predeterminadas (solo para Admins) -->
            <div id="admin-tasks-container" class="busqueda-global-container" style="display: none;">
                <h3>Gesti√≥n de Tareas Predeterminadas</h3>
                <div class="busqueda-global-input">
                    <input type="text" id="new-preset-task-input" placeholder="Escribe una nueva tarea predeterminada...">
                    <button id="add-preset-task-button">Agregar Tarea</button>
                </div>
                <div id="preset-tasks-list-container">
                    <div class="loader-container" id="preset-tasks-loader" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                    <ul id="preset-tasks-list" style="list-style-type: none; padding: 0;"></ul>
                </div>
            </div>

            <div class="grupo-vias" id="container-1-40"><div class="loader-container"><div class="spinner"></div></div><h2>RICCHERI (V√≠as 1 - 40)</h2><div id="grupo-1-40" class="vias-grid"></div><p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p></div>
            <div class="grupos-secundarios-container"><div class="grupo-vias" id="container-43-44"><div class="loader-container"><div class="spinner"></div></div><h2>DONOVAN (V√≠as 43 - 44)</h2><div id="grupo-43-44" class="vias-grid"></div><p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p></div><div class="grupo-vias" id="container-46-47"><div class="loader-container"><div class="spinner"></div></div><h2>BOULOGNE SUR MER (V√≠as 46 - 47)</h2><div id="grupo-46-47" class="vias-grid"></div><p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p></div><div class="grupo-vias" id="container-50-51"><div class="loader-container"><div class="spinner"></div></div><h2>MERCADO CENTRAL (V√≠as 50 - 51)</h2><div id="grupo-50-51" class="vias-grid"></div><p class="no-results-message">No se encontraron v√≠as con los filtros aplicados.</p></div></div>
        </main>
    </div>

    <div id="modal-via" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modal-title"></h2>
            <div class="modal-body">
                <div id="barrera-form-section" class="form-section" style="display: none;">
                    <h3>Gesti√≥n de Equipo</h3>
                    <form id="form-barrera">
                        <label for="modelo-barrera-input">Modelo de Barrera:</label>
                        <input type="text" id="modelo-barrera-input" placeholder="Ej: SafeGate 2.0">
                        <button type="button" id="guardar-modelo-barrera">Guardar Modelo</button>
                    </form>
                </div>
                <div style="display: flex; gap: 25px;">
                    <div class="tasks-section"><div class="modal-tabs"><button id="tab-pendientes" class="active">Pendientes</button><button id="tab-historial">Historial</button></div><div id="content-pendientes" class="tab-content active"><div class="novedades-container"><div class="loader-container"><div class="spinner"></div></div><ul id="lista-pendientes" style="list-style-type: none; padding: 0;"></ul></div></div><div id="content-historial" class="tab-content"><div class="historial-filtros"><input type="search" id="historial-search" placeholder="Buscar en el historial..."><input type="date" id="historial-date-picker"></div><div class="novedades-container"><div class="loader-container"><div class="spinner"></div></div><ul id="lista-historial" style="list-style-type: none; padding: 0;"></ul></div><div id="historial-pagination" class="pagination-controls"></div></div></div>
                    
                    <!-- <<< FORMULARIO MODIFICADO >>> -->
                    <div class="form-section">
                        <h3>Agregar Tarea</h3>
                        <form id="form-novedad">
                            <input type="hidden" id="via-id-input">
                            
                            <!-- NUEVO: Selector para tareas predeterminadas -->
                            <label for="select-tarea-predeterminada">Elegir Tarea Predeterminada (Opcional):</label>
                            <select id="select-tarea-predeterminada">
                                <option value="">-- Escribir tarea manualmente --</option>
                            </select>

                            <label for="descripcion-novedad">Descripci√≥n de la Tarea:</label>
                            <textarea id="descripcion-novedad" rows="4" placeholder="Describir la tarea pendiente..."></textarea>
                            
                            <label for="status-via">Estado de la V√≠a:</label>
                            <select id="status-via">
                                <option value="normal">Normal (Verde)</option>
                                <option value="revisar">Revisar (Amarillo)</option>
                                <option value="problema">Problema (Rojo)</option>
                            </select>
                            
                            <!-- NUEVO: Checkbox para marcar como resuelta -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <input type="checkbox" id="marcar-resuelta-input" style="width: auto;">
                                <label for="marcar-resuelta-input" style="margin-bottom: 0;">Marcar como resuelta inmediatamente</label>
                            </div>

                            <button type="submit">Guardar</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="tooltip-problema"></div>

    <div id="poroto-jar-container">
        <div id="poroto-jar">
            <div id="porotos-container"></div>
        </div>
        <div id="poroto-counter">0 / 20</div>
    </div>

    <footer id="page-footer">
        <p class="neon-text">&copy; <span id="footer-year"></span> - Desarrollado por El SR.H sin fines de Lucro</p>
    </footer>

    <script>
        // --- Configuraci√≥n y Elementos DOM ---
        const SUPABASE_URL = 'https://ybrwwgkouxdgdfpdofin.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlicnd3Z2tvdXhkZ2RmcGRvZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjU3MzksImV4cCI6MjA3NTEwMTczOX0.oxBJ8P1lyu8fL6eSFYRatCiP4XRg2xtdUJa8pqjNvxo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const loginContainer = document.getElementById('login-container'), mainContent = document.getElementById('main-content'), modal = document.getElementById('modal-via'), searchBox = document.getElementById('search-box'), filterButtons = document.querySelectorAll('.filter-buttons button'), tooltipProblema = document.getElementById('tooltip-problema'), loginForm = document.getElementById('login-form'), loginButton = document.getElementById('login-button'), loginError = document.getElementById('login-error'), logoutButton = document.getElementById('logout-button'), userEmailDisplay = document.getElementById('user-email-display'), userRoleDisplay = document.getElementById('user-role-display'), closeButton = document.querySelector('.close-button'), formNovedad = document.getElementById('form-novedad');
        
        const adminTasksContainer = document.getElementById('admin-tasks-container'),
              addPresetTaskButton = document.getElementById('add-preset-task-button'),
              newPresetTaskInput = document.getElementById('new-preset-task-input'),
              presetTasksList = document.getElementById('preset-tasks-list'),
              presetTasksLoader = document.getElementById('preset-tasks-loader'),
              selectTareaPredeterminada = document.getElementById('select-tarea-predeterminada'),
              marcarResueltaInput = document.getElementById('marcar-resuelta-input');
            
        let currentUserEmail = null, currentUserRole = 'operator', filtroActivo = 'todos', canalVias = null, todasLasVias = [], viaActualModal = null;
        let tareasPredeterminadas = [];
        let tooltipTimer = null; 

        const esAdmin = () => currentUserRole === 'admin';

        // --- L√ìGICA PARA EL FRASCO DE POROTOS --- (Sin cambios)
        const MAX_POROTOS = 20; let porotoCount = 0; const porotosContainer = document.getElementById('porotos-container'), porotoCounterDisplay = document.getElementById('poroto-counter'), porotoJar = document.getElementById('poroto-jar'); function addPoroto() { if (porotoCount >= MAX_POROTOS) return; porotoCount++; localStorage.setItem('porotoCount', porotoCount); const poroto = document.createElement('div'); poroto.className = 'poroto'; porotosContainer.appendChild(poroto); updatePorotoCounter(); if (porotoCount === MAX_POROTOS) { porotoJar.classList.add('jar-full-animation'); mostrarNotificacion('¬°Frasco lleno! Buen trabajo equipo. üéâ', 'success'); setTimeout(resetJar, 2000); } } function resetJar() { porotoJar.classList.remove('jar-full-animation'); const porotos = porotosContainer.querySelectorAll('.poroto'); porotos.forEach(p => p.classList.add('poroto-exit')); setTimeout(() => { porotosContainer.innerHTML = ''; porotoCount = 0; localStorage.setItem('porotoCount', 0); updatePorotoCounter(); }, 500); } function updatePorotoCounter() { porotoCounterDisplay.textContent = `${porotoCount} / ${MAX_POROTOS}`; } function renderJarState() { const savedCount = parseInt(localStorage.getItem('porotoCount')) || 0; porotoCount = savedCount; porotosContainer.innerHTML = ''; for (let i = 0; i < porotoCount; i++) { const poroto = document.createElement('div'); poroto.className = 'poroto'; poroto.style.animation = 'none'; porotosContainer.appendChild(poroto); } updatePorotoCounter(); }

        // --- L√ìGICA DE TOOLTIPS --- (Sin cambios)
        async function mostrarTooltip(viaId, targetElement, status) { tooltipProblema.className = `tooltip-${status}`; const { data, error } = await supabase.from('novedades').select('descripcion').eq('via_id', viaId).eq('resuelta', false).order('created_at', { ascending: false }).limit(1).single(); if (error || !data) { tooltipProblema.innerHTML = '<strong>No hay tareas pendientes.</strong>'; } else { tooltipProblema.innerHTML = `<strong>√öltima Tarea Pendiente:</strong> ${data.descripcion}`; } const rect = targetElement.getBoundingClientRect(); tooltipProblema.style.left = `${rect.left + window.scrollX}px`; tooltipProblema.style.top = `${rect.bottom + window.scrollY + 5}px`; tooltipProblema.classList.add('visible'); } function ocultarTooltip() { tooltipProblema.classList.remove('visible'); }

        // --- Bloque de funciones para gestionar tareas predeterminadas ---
        
        async function cargarYRenderizarTareasPredeterminadas() { if (!esAdmin()) return; presetTasksLoader.style.display = 'flex'; presetTasksList.innerHTML = ''; try { const { data, error } = await supabase.from('tareas_predeterminadas').select('id, descripcion').order('descripcion', { ascending: true }); if (error) throw error; tareasPredeterminadas = data; if (data.length === 0) { presetTasksList.innerHTML = '<li>No hay tareas predeterminadas.</li>'; } else { data.forEach(task => { const li = document.createElement('li'); li.innerHTML = `<span>${task.descripcion}</span><button data-id="${task.id}" class="delete-preset-task">Eliminar</button>`; presetTasksList.appendChild(li); }); } } catch (error) { console.error("Error al cargar tareas predeterminadas:", error); mostrarNotificacion("No se pudieron cargar las tareas predeterminadas.", "error"); } finally { presetTasksLoader.style.display = 'none'; } }
        
        // <<< MODIFICACI√ìN CLAVE: Quitar refresco manual >>>
        async function agregarTareaPredeterminada() {
            const descripcion = newPresetTaskInput.value.trim();
            if (!descripcion) {
                mostrarNotificacion("La descripci√≥n no puede estar vac√≠a.", "error");
                return;
            }
            addPresetTaskButton.disabled = true;
            try {
                const { error } = await supabase.from('tareas_predeterminadas').insert([{ descripcion }]);
                if (error) throw error;
                mostrarNotificacion("Tarea predeterminada agregada.", "success");
                newPresetTaskInput.value = '';
                // await cargarYRenderizarTareasPredeterminadas(); // <<< L√çNEA ELIMINADA para evitar doble refresco
            } catch (error) {
                console.error("Error al agregar tarea predeterminada:", error);
                mostrarNotificacion("Error al guardar la tarea.", "error");
            } finally {
                addPresetTaskButton.disabled = false;
            }
        }
        
        // <<< MODIFICACI√ìN CLAVE: Quitar refresco manual >>>
        async function eliminarTareaPredeterminada(id) {
            if (!confirm("¬øSeguro que quieres eliminar esta tarea predeterminada?")) return;
            try {
                const { error } = await supabase.from('tareas_predeterminadas').delete().eq('id', id);
                if (error) throw error;
                mostrarNotificacion("Tarea predeterminada eliminada.", "success");
                // await cargarYRenderizarTareasPredeterminadas(); // <<< L√çNEA ELIMINADA para evitar doble refresco
            } catch (error) {
                console.error("Error al eliminar tarea predeterminada:", error);
                mostrarNotificacion("Error al eliminar la tarea.", "error");
            }
        }
        
        async function inicializarPanelesYDatos() { await cargarVias(); if (esAdmin()) { adminTasksContainer.style.display = 'block'; await cargarYRenderizarTareasPredeterminadas(); } else { adminTasksContainer.style.display = 'none'; const { data, error } = await supabase.from('tareas_predeterminadas').select('id, descripcion'); if (!error) { tareasPredeterminadas = data; } } }

        // --- L√ìGICA PRINCIPAL ---
        async function cargarVias() {
            document.querySelectorAll('.loader-container').forEach(loader => loader.style.display = 'flex');
            try {
                const { data: vias, error } = await supabase.from('vias').select(`id, numero_via, status, modelo_barrera`).order('numero_via', { ascending: true });
                if (error) throw error;
                todasLasVias = vias;
                document.querySelectorAll('.vias-grid').forEach(g => g.innerHTML = '');

                for (const via of vias) {
                    const viaBox = document.createElement('div');
                    viaBox.className = `via-box status-${via.status}`;
                    viaBox.dataset.viaId = via.id;
                    viaBox.dataset.viaStatus = via.status;
                    const modeloTexto = via.modelo_barrera || '';
                    let barreraHTML = '';
                    if(modeloTexto) {
                        barreraHTML = `<div class="barrera-info" title="Modelo: ${modeloTexto}"><svg class="barrera-icono" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><path d="M6 30 V 11 H 16 V 6 H 6 V 0 H 4 V 6 H 0 V 11 H 4 V 30 Z M 16 11 H 30 V 8 H 16 Z" fill="#d8dee9" stroke="none"></path></svg><span class="barrera-modelo-nombre">${modeloTexto}</span></div>`;
                    }
                    viaBox.innerHTML = `${via.numero_via}${barreraHTML}`;
                    
                    if (via.status === 'problema' || via.status === 'revisar') {
                        viaBox.addEventListener('mouseenter', () => {
                            clearTimeout(tooltipTimer);
                            tooltipTimer = setTimeout(() => {
                                mostrarTooltip(via.id, viaBox, via.status);
                            }, 300); 
                        });

                        viaBox.addEventListener('mouseleave', () => {
                            clearTimeout(tooltipTimer);
                            ocultarTooltip();
                        });
                    }
                    
                    viaBox.addEventListener('click', () => mostrarModal(via));
                    const grupoId = via.numero_via <= 40 ? 'grupo-1-40' : via.numero_via <= 44 ? 'grupo-43-44' : via.numero_via <= 47 ? 'grupo-46-47' : 'grupo-50-51';
                    document.getElementById(grupoId).appendChild(viaBox);
                }
                actualizarDashboard();
                filtrarVias();
            } catch (error) {
                console.error('Error al cargar las v√≠as:', error);
                mostrarNotificacion('No se pudieron cargar los datos.', 'error');
            } finally {
                document.querySelectorAll('.grupo-vias .loader-container').forEach(loader => loader.style.display = 'none');
            }
        }
        
        async function buscarProblemaGlobal() { const searchTerm = document.getElementById('global-search-box').value.trim(); const resultsContainer = document.getElementById('global-search-results-container'), resultsList = document.getElementById('global-search-results-list'), loader = document.getElementById('global-search-loader'), noResultsMessage = document.getElementById('no-global-results-message'); if (!searchTerm) { mostrarNotificacion('Por favor, ingresa un t√©rmino de b√∫squeda.', 'error'); return; } resultsContainer.style.display = 'block'; loader.style.display = 'flex'; resultsList.innerHTML = ''; noResultsMessage.style.display = 'none'; try { const { data, error } = await supabase.from('novedades').select(`id, descripcion, created_at, resuelta, resolved_at, resolved_by, user_email, vias ( numero_via )`).ilike('descripcion', `%${searchTerm}%`).order('created_at', { ascending: false }); if (error) throw error; if (data.length > 0) { data.forEach(novedad => { const li = document.createElement('li'); const fechaCreacion = new Date(novedad.created_at).toLocaleString('es-AR'); let metaInfo = `<span class="resultado-meta"><span class="fecha">${fechaCreacion}</span> - Creado por ${novedad.user_email || 'Sistema'}</span>`; if(novedad.resuelta && novedad.resolved_at) { const fechaResolucion = new Date(novedad.resolved_at).toLocaleString('es-AR'); metaInfo += `<span class="resultado-meta">Resuelto por ${novedad.resolved_by} el ${fechaResolucion}</span>`; } li.innerHTML = `<div><span class="resultado-via-numero">V√≠a ${novedad.vias.numero_via}</span><span class="estado-tag ${novedad.resuelta ? 'resuelta' : ''}">${novedad.resuelta ? 'Resuelto' : 'Pendiente'}</span></div><p class="resultado-descripcion">${novedad.descripcion}</p>${metaInfo}`; resultsList.appendChild(li); }); } else { noResultsMessage.style.display = 'block'; } } catch (error) { console.error('Error en la b√∫squeda global:', error); mostrarNotificacion('Ocurri√≥ un error al realizar la b√∫squeda.', 'error'); } finally { loader.style.display = 'none'; } }
        
        async function mostrarModal(via) {
            viaActualModal = via;
            document.getElementById('modal-title').textContent = `Tareas y Novedades - V√≠a ${via.numero_via}`;
            document.getElementById('via-id-input').value = via.id;
            document.getElementById('status-via').value = via.status;
            document.getElementById('descripcion-novedad').value = '';
            marcarResueltaInput.checked = false; 
            selectTareaPredeterminada.value = "";

            const barreraForm = document.getElementById('barrera-form-section');
            if (esAdmin()) {
                barreraForm.style.display = 'block';
                document.getElementById('modelo-barrera-input').value = via.modelo_barrera || '';
            } else {
                barreraForm.style.display = 'none';
            }

            selectTareaPredeterminada.innerHTML = '<option value="">-- Escribir tarea manualmente --</option>';
            if (tareasPredeterminadas.length > 0) {
                tareasPredeterminadas.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.descripcion;
                    option.textContent = task.descripcion;
                    selectTareaPredeterminada.appendChild(option);
                });
            }
            
            document.getElementById('status-via').disabled = false;
            document.getElementById('tab-pendientes').click();
            modal.style.display = 'block';
            await cargarNovedadesModal();
        }

        async function guardarModeloBarrera() { const botonGuardar = document.getElementById('guardar-modelo-barrera'); const nuevoModelo = document.getElementById('modelo-barrera-input').value.trim(); if (!viaActualModal) return; botonGuardar.disabled = true; botonGuardar.textContent = 'Guardando...'; try { const { error } = await supabase.from('vias').update({ modelo_barrera: nuevoModelo }).eq('id', viaActualModal.id); if (error) throw error; viaActualModal.modelo_barrera = nuevoModelo; mostrarNotificacion('Modelo de barrera actualizado con √©xito.', 'success'); } catch (error) { console.error('Error al guardar el modelo de la barrera:', error); mostrarNotificacion('No se pudo guardar el modelo de la barrera.', 'error'); } finally { botonGuardar.disabled = false; botonGuardar.textContent = 'Guardar Modelo'; } }
        async function cargarNovedadesModal(historialPage = 1) { const listaPendientes = document.getElementById('lista-pendientes'), listaHistorial = document.getElementById('lista-historial'), loaders = document.querySelectorAll('.novedades-container .loader-container'); loaders.forEach(l => l.style.display = 'flex'); listaPendientes.innerHTML = ''; listaHistorial.innerHTML = ''; try { const { data: pendientes, error: errPend } = await supabase.from('novedades').select('*').eq('via_id', viaActualModal.id).eq('resuelta', false).order('created_at', { ascending: true }); if (errPend) throw errPend; if (pendientes.length > 0) { pendientes.forEach(n => listaPendientes.appendChild(crearItemNovedad(n, false))); } else { listaPendientes.innerHTML = '<li>No hay tareas pendientes.</li>'; } const NOVEDADES_PER_PAGE = 5, from = (historialPage - 1) * NOVEDADES_PER_PAGE, to = from + NOVEDADES_PER_PAGE - 1, textoBusqueda = document.getElementById('historial-search').value.trim(), fechaSeleccionada = document.getElementById('historial-date-picker').value; let queryHistorial = supabase.from('novedades').select('*', { count: 'exact' }).eq('via_id', viaActualModal.id).eq('resuelta', true); if (textoBusqueda) queryHistorial = queryHistorial.ilike('descripcion', `%${textoBusqueda}%`); if (fechaSeleccionada) { const fechaInicio = `${fechaSeleccionada}T00:00:00`, fechaFin = `${fechaSeleccionada}T23:59:59`; queryHistorial = queryHistorial.gte('created_at', fechaInicio).lte('created_at', fechaFin); } const { data: resueltas, count, error: errRes } = await queryHistorial.order('created_at', { ascending: false }).range(from, to); if (errRes) throw errRes; if (resueltas.length > 0) { resueltas.forEach(n => listaHistorial.appendChild(crearItemNovedad(n, true))); } else { listaHistorial.innerHTML = '<li>No hay historial de tareas resueltas.</li>'; } renderizarControlesPaginacion(historialPage, count, NOVEDADES_PER_PAGE); } catch (error) { console.error("Error cargando novedades:", error); mostrarNotificacion('Error al cargar las tareas.', 'error'); } finally { loaders.forEach(l => l.style.display = 'none'); } }
        function crearItemNovedad(novedad, esResuelta) { const item = document.createElement('li'); item.className = esResuelta ? 'novedad-resuelta' : 'novedad-pendiente'; item.dataset.novedadId = novedad.id; const fechaCreacion = new Date(novedad.created_at).toLocaleString('es-AR'); let infoAuditoria = ''; if (esResuelta && novedad.resolved_at && novedad.resolved_by) { const fechaResolucion = new Date(novedad.resolved_at).toLocaleString('es-AR'); infoAuditoria = `<span class="meta-info resuelta-info">Resuelta por ${novedad.resolved_by} el ${fechaResolucion}</span>`; } let botonesAccion = ''; const puedeEditar = esAdmin() || novedad.user_email === currentUserEmail; if (!esResuelta) { botonesAccion += `<button class="btn-resolver" title="Marcar como Resuelta">‚úîÔ∏è</button>`; } if (puedeEditar) { botonesAccion += `<button class="btn-editar" title="Editar">‚úèÔ∏è</button>`; } if (esAdmin()) { botonesAccion += `<button class="btn-eliminar" title="Eliminar">üóëÔ∏è</button>`; } item.innerHTML = `<div class="novedad-contenido"><span class="meta-info">Creada por ${novedad.user_email || 'Sistema'} el ${fechaCreacion}</span>${infoAuditoria}<p class="descripcion-texto">${novedad.descripcion}</p></div><div class="novedad-acciones">${botonesAccion}</div>`; return item; }
        
        // <<< MODIFICACI√ìN CLAVE: Quitar refresco manual >>>
        async function resolverNovedad(novedadId) {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { mostrarNotificacion('Sesi√≥n inv√°lida', 'error'); return; }
            const updatePayload = { resuelta: true, resolved_at: new Date().toISOString(), resolved_by: user.email };
            const { error } = await supabase.from('novedades').update(updatePayload).eq('id', novedadId);
            if (error) { mostrarNotificacion('Error al resolver la tarea.', 'error'); return; }
            addPoroto();
            mostrarNotificacion('Muy Bien, ¬°te ganaste 1 poroto! ü•≥');
            const { count } = await supabase.from('novedades').select('*', { count: 'exact', head: true }).eq('via_id', viaActualModal.id).eq('resuelta', false);
            if (count === 0 && viaActualModal.status !== 'normal') {
                const { error: updateError } = await supabase.from('vias').update({ status: 'normal' }).eq('id', viaActualModal.id);
                if (!updateError) {
                    mostrarNotificacion(`V√≠a ${viaActualModal.numero_via} pasada a estado Normal.`, 'success');
                    // await cargarVias(); // <<< L√çNEA ELIMINADA para evitar doble refresco
                }
            }
            // await cargarNovedadesModal(); // <<< L√çNEA ELIMINADA para evitar doble refresco
        }
        
        // <<< MODIFICACI√ìN CLAVE: Quitar refresco manual >>>
        async function manejarEliminarNovedad(novedadId) {
            if (!esAdmin()) { mostrarNotificacion('No tienes permisos para eliminar.', 'error'); return; }
            if (confirm("¬øSeguro que desea eliminar esta tarea/novedad?")) {
                const { error } = await supabase.from('novedades').delete().eq('id', novedadId);
                if (error) mostrarNotificacion("Error al eliminar", 'error');
                else {
                    mostrarNotificacion("Eliminado con √©xito.");
                    // await cargarNovedadesModal(); // <<< L√çNEA ELIMINADA para evitar doble refresco
                }
            }
        }
        
        // <<< MODIFICACI√ìN CLAVE: Quitar refresco manual >>>
        async function guardarEdicionNovedad(itemLi, novedadId) {
            const nuevoTexto = itemLi.querySelector('.edit-textarea').value.trim();
            if(nuevoTexto){
                const { error } = await supabase.from('novedades').update({ descripcion: nuevoTexto }).eq('id', novedadId);
                if(error) mostrarNotificacion('Error al guardar la edici√≥n.', 'error');
                else {
                    mostrarNotificacion('Tarea actualizada.');
                    // await cargarNovedadesModal(); // <<< L√çNEA ELIMINADA para evitar doble refresco
                }
            } else {
                mostrarNotificacion('La descripci√≥n no puede estar vac√≠a.', 'error');
            }
        }

        function mostrarEditorNovedad(itemLi) { const contenido = itemLi.querySelector('.novedad-contenido'), textoActual = contenido.querySelector('.descripcion-texto').innerText; itemLi.querySelector('.novedad-acciones').style.display = 'none'; contenido.innerHTML = `<div class="edit-container"><textarea class="edit-textarea">${textoActual}</textarea><div class="edit-actions"><button class="btn-guardar-edicion">Guardar</button><button class="btn-cancelar-edicion">Cancelar</button></div></div>`; }
        function mostrarNotificacion(mensaje, tipo = 'success') { const container = document.getElementById('toast-container'), toast = document.createElement('div'); toast.className = `toast ${tipo}`; toast.textContent = mensaje; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 100); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000); }
        function actualizarDashboard() { const counts = todasLasVias.reduce((acc, via) => { acc[via.status] = (acc[via.status] || 0) + 1; return acc; }, {}); document.getElementById('stat-count-problema').textContent = counts.problema || 0; document.getElementById('stat-count-revisar').textContent = counts.revisar || 0; document.getElementById('stat-count-normal').textContent = counts.normal || 0; }
        function renderizarControlesPaginacion(currentPage, totalItems, perPage) { const paginationContainer = document.getElementById('historial-pagination'); paginationContainer.innerHTML = ''; const totalPages = Math.ceil(totalItems / perPage); if (totalPages <= 1) return; const prevButton = document.createElement('button'); prevButton.textContent = 'Anterior'; prevButton.disabled = currentPage === 1; prevButton.onclick = () => cargarNovedadesModal(currentPage - 1); const pageInfo = document.createElement('span'); pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`; const nextButton = document.createElement('button'); nextButton.textContent = 'Siguiente'; nextButton.disabled = currentPage === totalPages; nextButton.onclick = () => cargarNovedadesModal(currentPage + 1); paginationContainer.append(prevButton, pageInfo, nextButton); }
        
        const handleLogin = async (event) => { event.preventDefault(); loginButton.disabled = true; loginButton.textContent = 'Accediendo...'; loginError.style.display = 'none'; const email = document.getElementById('email').value, password = document.getElementById('password').value; try { const { data, error } = await supabase.auth.signInWithPassword({ email, password }); if (error) throw error; const { data: profile, error: profileError } = await supabase.from('profiles').select('role').eq('id', data.user.id).single(); if (profileError) throw profileError; loginContainer.style.display = 'none'; mainContent.style.display = 'block'; currentUserEmail = data.user.email; currentUserRole = profile.role || 'operator'; userEmailDisplay.textContent = currentUserEmail; userRoleDisplay.textContent = currentUserRole; await inicializarPanelesYDatos(); escucharCambiosVias(); } catch (error) { console.error('Error de login:', error.message); loginError.style.display = 'block'; mostrarNotificacion('Usuario o contrase√±a incorrectos.', 'error'); } finally { loginButton.disabled = false; loginButton.textContent = 'Acceder'; } };
        const checkUser = async () => { const { data: { session } } = await supabase.auth.getSession(); if (session) { const { data: profile, error: profileError } = await supabase.from('profiles').select('role').eq('id', session.user.id).single(); if (profileError) { await handleLogout(); return; } loginContainer.style.display = 'none'; mainContent.style.display = 'block'; currentUserEmail = session.user.email; currentUserRole = profile.role || 'operator'; userEmailDisplay.textContent = currentUserEmail; userRoleDisplay.textContent = currentUserRole; await inicializarPanelesYDatos(); escucharCambiosVias(); } else { loginContainer.style.display = 'block'; mainContent.style.display = 'none'; } };
        const handleLogout = async () => { if (canalVias) { supabase.removeChannel(canalVias); canalVias = null; } await supabase.auth.signOut(); mainContent.style.display = 'none'; loginContainer.style.display = 'block'; adminTasksContainer.style.display = 'none'; currentUserEmail = null; currentUserRole = 'operator'; };
        function cerrarModal() { modal.style.display = 'none'; viaActualModal = null; }
        
        // <<< MODIFICACI√ìN CLAVE: Quitar refresco manual >>>
        async function manejarSubmitNovedad(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Guardando...';

            try {
                const idVia = document.getElementById('via-id-input').value;
                const nuevaDescripcion = document.getElementById('descripcion-novedad').value.trim();
                const nuevoStatus = document.getElementById('status-via').value;
                const marcarComoResuelta = marcarResueltaInput.checked;

                if (!nuevaDescripcion) {
                    mostrarNotificacion('La descripci√≥n de la tarea no puede estar vac√≠a.', 'error');
                    return;
                }

                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    mostrarNotificacion('Sesi√≥n expirada.', 'error');
                    return;
                }

                const insertPayload = {
                    via_id: idVia,
                    descripcion: nuevaDescripcion,
                    user_email: user.email,
                    resuelta: marcarComoResuelta
                };

                if (marcarComoResuelta) {
                    insertPayload.resolved_at = new Date().toISOString();
                    insertPayload.resolved_by = user.email;
                }

                const { error: insertError } = await supabase.from('novedades').insert([insertPayload]);
                if (insertError) throw insertError;
                
                if (marcarComoResuelta) {
                    addPoroto();
                    mostrarNotificacion('Tarea agregada y resuelta. ¬°Te ganaste 1 poroto! ü•≥');
                } else {
                    mostrarNotificacion('Tarea agregada con √©xito!');
                }

                if (nuevoStatus !== viaActualModal.status) {
                    const { error: updateError } = await supabase.from('vias').update({ status: nuevoStatus }).eq('id', idVia);
                    if (updateError) throw updateError;
                    // await cargarVias(); // <<< L√çNEA ELIMINADA para evitar doble refresco
                }
                
                // await cargarNovedadesModal(); // <<< L√çNEA ELIMINADA para evitar doble refresco
                document.getElementById('descripcion-novedad').value = '';
                marcarResueltaInput.checked = false; 
                selectTareaPredeterminada.value = "";

            } catch (error) {
                console.error('Error al guardar:', error);
                mostrarNotificacion('Error al guardar la tarea.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Guardar';
            }
        }
        
        function filtrarVias() {
            const textoBusqueda = searchBox.value.toLowerCase();
            document.querySelectorAll('.grupo-vias').forEach(grupo => {
                let viasVisibles = 0;
                const viasEnGrupo = grupo.querySelectorAll('.via-box');
                viasEnGrupo.forEach(via => {
                    const coincideBusqueda = via.textContent.toLowerCase().includes(textoBusqueda);
                    const coincideFiltro = (filtroActivo === 'todos') || (via.dataset.viaStatus === filtroActivo);
                    if (coincideBusqueda && coincideFiltro) {
                        via.style.display = 'block';
                        viasVisibles++;
                    } else {
                        via.style.display = 'none';
                    }
                });
                const mensajeVacio = grupo.querySelector('.no-results-message');
                mensajeVacio.style.display = viasVisibles === 0 ? 'block' : 'none';
            })
        }

        // <<< MODIFICACI√ìN CLAVE: Listener se convierte en la √∫nica fuente de verdad para los refrescos >>>
        function escucharCambiosVias() { 
            if (canalVias) return; 

            canalVias = supabase.channel('cambios-db-vias')
                .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => { 
                    
                    console.log('Cambio en tiempo real detectado en la tabla:', payload.table); 
                    
                    if (payload.table === 'vias' || payload.table === 'novedades') { 
                        cargarVias(); 
                        if (modal.style.display === 'block' && viaActualModal) { 
                            cargarNovedadesModal(); 
                        } 
                    } 
                    
                    if (payload.table === 'tareas_predeterminadas') { 
                        if(esAdmin()) {
                            cargarYRenderizarTareasPredeterminadas(); 
                        } else {
                            // Para usuarios no-admin, solo actualizamos el array interno para el <select> del modal
                            supabase.from('tareas_predeterminadas').select('id, descripcion').then(({data}) => {
                                if(data) tareasPredeterminadas = data;
                            });
                        }
                    }
                
                }).subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('¬°Conectado al canal de tiempo real!');
                    }
                }); 
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            document.getElementById('footer-year').textContent = new Date().getFullYear(); 
            renderJarState(); 
            checkUser(); 
            loginForm.addEventListener('submit', handleLogin); 
            logoutButton.addEventListener('click', handleLogout); 
            closeButton.addEventListener('click', cerrarModal); 
            window.addEventListener('click', (event) => { if (event.target == modal) { cerrarModal(); } }); 
            formNovedad.addEventListener('submit', manejarSubmitNovedad); 
            searchBox.addEventListener('input', filtrarVias); 
            filterButtons.forEach(button => { button.addEventListener('click', () => { filterButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); filtroActivo = button.id.replace('filter-', ''); filtrarVias(); }); }); 
            document.getElementById('tab-pendientes').addEventListener('click', (e) => { document.getElementById('content-pendientes').classList.add('active'); document.getElementById('content-historial').classList.remove('active'); e.target.classList.add('active'); document.getElementById('tab-historial').classList.remove('active'); }); 
            document.getElementById('tab-historial').addEventListener('click', (e) => { document.getElementById('content-historial').classList.add('active'); document.getElementById('content-pendientes').classList.remove('active'); e.target.classList.add('active'); document.getElementById('tab-pendientes').classList.remove('active'); }); 
            document.getElementById('historial-search').addEventListener('input', () => cargarNovedadesModal(1)); 
            document.getElementById('historial-date-picker').addEventListener('change', () => cargarNovedadesModal(1)); 
            const globalSearchButton = document.getElementById('global-search-button'), globalSearchBox = document.getElementById('global-search-box'); 
            globalSearchButton.addEventListener('click', buscarProblemaGlobal); 
            globalSearchBox.addEventListener('keyup', (event) => { if (event.key === 'Enter') { buscarProblemaGlobal(); } }); 
            globalSearchBox.addEventListener('input', () => { if (globalSearchBox.value.trim() === '') { document.getElementById('global-search-results-container').style.display = 'none'; } }); 
            document.getElementById('guardar-modelo-barrera').addEventListener('click', guardarModeloBarrera); 
            document.querySelector('.tasks-section').addEventListener('click', async (e) => { const target = e.target, itemLi = target.closest('li'); if (!itemLi) return; const novedadId = itemLi.dataset.novedadId; if (target.classList.contains('btn-resolver')) { if (confirm("¬øMarcar esta tarea como resuelta?")) { await resolverNovedad(novedadId); } } else if (target.classList.contains('btn-eliminar')) { await manejarEliminarNovedad(novedadId); } else if (target.classList.contains('btn-editar')) { mostrarEditorNovedad(itemLi); } else if (target.classList.contains('btn-guardar-edicion')) { await guardarEdicionNovedad(itemLi, novedadId); } else if (target.classList.contains('btn-cancelar-edicion')) { await cargarNovedadesModal(); } });

            // <<< Listeners para las nuevas funcionalidades sin cambios >>>
            selectTareaPredeterminada.addEventListener('change', (e) => {
                if (e.target.value) {
                    document.getElementById('descripcion-novedad').value = e.target.value;
                }
            });
            addPresetTaskButton.addEventListener('click', agregarTareaPredeterminada);
            newPresetTaskInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    agregarTareaPredeterminada();
                }
            });
            presetTasksList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-preset-task')) {
                    const id = e.target.dataset.id;
                    eliminarTareaPredeterminada(id);
                }
            });
        });
    </script>
</body>
</html>
