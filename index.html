<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Vías de Peaje v3.5 - Tooltips Mejorados</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GENERALES Y FONDO --- */
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(-45deg, #2e3440, #3b4252, #434c5e, #4c566a); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #eceff4; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { max-width: 1400px; margin: 0 auto; width: 100%;}
        
        /* ... (resto de tus estilos CSS que no cambian) ... */

        .grupos-secundarios-container .grupo-vias { flex-grow: 1; margin-bottom: 0; }
        
        /* --- [MODIFICADO] ESTILOS TOOLTIP --- */
        #tooltip-problema {
            position: absolute;
            color: #2e3440; /* Texto oscuro para mejor contraste */
            padding: 10px 15px;
            border-radius: 6px;
            z-index: 1001;
            pointer-events: none;
            opacity: 0;
            font-size: 0.9em;
            max-width: 250px;
            text-align: left;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            /* Transición eliminada de aquí para controlarla en la clase .visible */
        }
        #tooltip-problema.visible {
            opacity: 1;
            transition: opacity 0.2s; /* La transición solo se aplica al aparecer */
        }
        #tooltip-problema strong {
            display: block;
            margin-bottom: 5px;
            padding-bottom: 5px;
        }
        /* [NUEVO] Colores de fondo para el tooltip */
        #tooltip-problema.tooltip-problema {
            background-color: #bf616a;
            color: #eceff4; /* Texto claro para fondo rojo */
        }
        #tooltip-problema.tooltip-problema strong {
            border-bottom: 1px solid rgba(236, 239, 244, 0.5);
        }
        #tooltip-problema.tooltip-revisar {
            background-color: #ebcb8b;
            color: #2e3440; /* Texto oscuro para fondo amarillo */
        }
        #tooltip-problema.tooltip-revisar strong {
             border-bottom: 1px solid rgba(46, 52, 64, 0.5);
        }
        
        /* ... (resto de tus estilos CSS hasta el final) ... */

        @keyframes neon-flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow:
                    0 0 4px #fff,
                    0 0 11px #fff,
                    0 0 19px #fff,
                    0 0 40px #88c0d0,
                    0 0 80px #88c0d0,
                    0 0 90px #88c0d0,
                    0 0 100px #88c0d0,
                    0 0 150px #88c0d0;
            }
            20%, 24%, 55% {
                text-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div id="login-container"><h1>Iniciar Sesión</h1><form id="login-form"><div class="input-group"><label for="email">Usuario (Email)</label><input type="email" id="email" required></div><div class="input-group"><label for="password">Contraseña</label><input type="password" id="password" required></div><button type="submit" id="login-button">Acceder</button><p id="login-error">Usuario o contraseña incorrectos.</p></form></div>
    <div id="main-content" style="display: none; width: 100%;"><header><h1>Sistema de Control y Novedades de Vías</h1><div id="user-info"><span id="user-email-display" style="margin-right: 15px; font-style: italic;"></span><span id="user-role-display"></span><button id="logout-button">Cerrar Sesión</button></div></header><main class="container"><div class="dashboard-stats"><div class="stat-box" id="stat-problema"><h3>Con Problema</h3><div class="stat-number" id="stat-count-problema">0</div></div><div class="stat-box" id="stat-revisar"><h3>Para Revisar</h3><div class="stat-number" id="stat-count-revisar">0</div></div><div class="stat-box" id="stat-normal"><h3>Normales</h3><div class="stat-number" id="stat-count-normal">0</div></div></div><div class="controles-vias"><input type="search" id="search-box" placeholder="Buscar por número de vía..."><div class="filter-buttons"><button id="filter-todos" class="active">Todos</button><button id="filter-normal">Normal</button><button id="filter-revisar">Revisar</button><button id="filter-problema">Problema</button></div></div><div class="grupo-vias" id="container-1-40"><div class="loader-container"><div class="spinner"></div></div><h2>RICCHERI (Vías 1 - 40)</h2><div id="grupo-1-40" class="vias-grid"></div><p class="no-results-message">No se encontraron vías con los filtros aplicados.</p></div><div class="grupos-secundarios-container"><div class="grupo-vias" id="container-43-44"><div class="loader-container"><div class="spinner"></div></div><h2>DONOVAN (Vías 43 - 44)</h2><div id="grupo-43-44" class="vias-grid"></div><p class="no-results-message">No se encontraron vías con los filtros aplicados.</p></div><div class="grupo-vias" id="container-46-47"><div class="loader-container"><div class="spinner"></div></div><h2>BOULOGNE SUR MER (Vías 46 - 47)</h2><div id="grupo-46-47" class="vias-grid"></div><p class="no-results-message">No se encontraron vías con los filtros aplicados.</p></div><div class="grupo-vias" id="container-50-51"><div class="loader-container"><div class="spinner"></div></div><h2>MERCADO CENTRAL (Vías 50 - 51)</h2><div id="grupo-50-51" class="vias-grid"></div><p class="no-results-message">No se encontraron vías con los filtros aplicados.</p></div></div></main></div>
    <div id="modal-via" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2 id="modal-title"></h2><div class="modal-body"><div class="tasks-section"><div class="modal-tabs"><button id="tab-pendientes" class="active">Pendientes</button><button id="tab-historial">Historial</button></div><div id="content-pendientes" class="tab-content active"><div class="novedades-container"><div class="loader-container"><div class="spinner"></div></div><ul id="lista-pendientes" style="list-style-type: none; padding: 0;"></ul></div></div><div id="content-historial" class="tab-content"><div class="historial-filtros"><input type="search" id="historial-search" placeholder="Buscar en el historial..."><input type="date" id="historial-date-picker"></div><div class="novedades-container"><div class="loader-container"><div class="spinner"></div></div><ul id="lista-historial" style="list-style-type: none; padding: 0;"></ul></div><div id="historial-pagination" class="pagination-controls"></div></div></div><div class="form-section"><h3>Agregar Tarea</h3><form id="form-novedad"><input type="hidden" id="via-id-input"><label for="descripcion-novedad">Nueva Tarea:</label><textarea id="descripcion-novedad" rows="4" placeholder="Describir la tarea pendiente..."></textarea><label for="status-via">Estado de la Vía:</label><select id="status-via"><option value="normal">Normal (Verde)</option><option value="revisar">Revisar (Amarillo)</option><option value="problema">Problema (Rojo)</option></select><button type="submit">Guardar</button></form></div></div></div></div>
    <div id="toast-container"></div>
    <div id="tooltip-problema"></div>

    <footer id="page-footer">
        <p class="neon-text">&copy; <span id="footer-year"></span> - Desarrollado por El Sr.H sin fines de Lucro</p>
    </footer>

    <script>
        // --- Configuración y Elementos DOM ---
        const SUPABASE_URL = 'https://ybrwwgkouxdgdfpdofin.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlicnd3Z2tvdXhkZ2RmcGRvZmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjU3MzksImV4cCI6MjA3NTEwMTczOX0.oxBJ8P1lyu8fL6eSFYRatCiP4XRg2xtdUJa8pqjNvxo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const loginContainer = document.getElementById('login-container'), mainContent = document.getElementById('main-content'), modal = document.getElementById('modal-via'), searchBox = document.getElementById('search-box'), filterButtons = document.querySelectorAll('.filter-buttons button'), tooltipProblema = document.getElementById('tooltip-problema'), loginForm = document.getElementById('login-form'), loginButton = document.getElementById('login-button'), loginError = document.getElementById('login-error'), logoutButton = document.getElementById('logout-button'), userEmailDisplay = document.getElementById('user-email-display'), userRoleDisplay = document.getElementById('user-role-display'), closeButton = document.querySelector('.close-button'), formNovedad = document.getElementById('form-novedad');
            
        let currentUserEmail = null, currentUserRole = 'operator', filtroActivo = 'todos', canalVias = null, todasLasVias = [], viaActualModal = null;

        const esAdmin = () => currentUserRole === 'admin';

        // --- [MODIFICADO] LÓGICA DE TOOLTIPS ---
        async function mostrarTooltip(viaId, targetElement, status) {
            // Asignar la clase de color ANTES de hacer la llamada a la BD
            tooltipProblema.className = `tooltip-${status}`;

            const { data, error } = await supabase.from('novedades').select('descripcion').eq('via_id', viaId).eq('resuelta', false).order('created_at', { ascending: false }).limit(1).single();
            if (error || !data) { tooltipProblema.innerHTML = '<strong>No hay tareas pendientes.</strong>'; } 
            else { tooltipProblema.innerHTML = `<strong>Última Tarea Pendiente:</strong> ${data.descripcion}`; }
            
            const rect = targetElement.getBoundingClientRect();
            tooltipProblema.style.left = `${rect.left + window.scrollX}px`;
            tooltipProblema.style.top = `${rect.bottom + window.scrollY + 5}px`;
            tooltipProblema.classList.add('visible');
        }

        function ocultarTooltip() {
            tooltipProblema.classList.remove('visible');
            // Eliminar la transición para que al reaparecer no tenga un delay visual
            tooltipProblema.style.transition = 'none';
            // Restaurar la transición después de un instante
            setTimeout(() => { tooltipProblema.style.transition = ''; }, 0);
        }

        // --- LÓGICA PRINCIPAL ---
        async function cargarVias() {
            document.querySelectorAll('.loader-container').forEach(loader => loader.style.display = 'flex');
            try {
                const { data: vias, error } = await supabase.from('vias').select(`id, numero_via, status`).order('numero_via', { ascending: true });
                if (error) throw error;
                todasLasVias = vias; 
                document.querySelectorAll('.vias-grid').forEach(g => g.innerHTML = '');
                
                for(const via of vias){
                    const viaBox = document.createElement('div');
                    viaBox.className = `via-box status-${via.status}`;
                    viaBox.textContent = via.numero_via;
                    viaBox.dataset.viaId = via.id;
                    viaBox.dataset.viaStatus = via.status;
                    
                    // [MODIFICADO] Activar tooltip para 'problema' Y 'revisar'
                    if (via.status === 'problema' || via.status === 'revisar') {
                        viaBox.addEventListener('mouseenter', () => mostrarTooltip(via.id, viaBox, via.status));
                        viaBox.addEventListener('mouseleave', ocultarTooltip);
                    }

                    viaBox.addEventListener('click', () => mostrarModal(via));
                    
                    const grupoId = via.numero_via <= 40 ? 'grupo-1-40' : via.numero_via <= 44 ? 'grupo-43-44' : via.numero_via <= 47 ? 'grupo-46-47' : 'grupo-50-51';
                    document.getElementById(grupoId).appendChild(viaBox);
                }
                actualizarDashboard();
                filtrarVias();
            } catch (error) {
                console.error('Error al cargar las vías:', error);
                mostrarNotificacion('No se pudieron cargar los datos.', 'error');
            } finally {
                document.querySelectorAll('.grupo-vias .loader-container').forEach(loader => loader.style.display = 'none');
            }
        }
        
        // ... (resto de tu código JavaScript funcional y sin cambios) ...

        const handleLogout = async () => {
            if (canalVias) {
                supabase.removeChannel(canalVias);
                canalVias = null;
            }
            await supabase.auth.signOut();
            mainContent.style.display = 'none';
            loginContainer.style.display = 'block';
            currentUserEmail = null;
            currentUserRole = 'operator';
        };

        function cerrarModal() {
            modal.style.display = 'none';
            viaActualModal = null;
        }

        async function manejarSubmitNovedad(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Guardando...';
            try {
                const idVia = document.getElementById('via-id-input').value;
                const nuevaDescripcion = document.getElementById('descripcion-novedad').value.trim();
                const nuevoStatus = document.getElementById('status-via').value;

                if (!nuevaDescripcion) {
                    mostrarNotificacion('La descripción de la tarea no puede estar vacía.', 'error');
                    return;
                }
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    mostrarNotificacion('Sesión expirada.', 'error');
                    return;
                }
                
                const { error: insertError } = await supabase.from('novedades').insert([{ via_id: idVia, descripcion: nuevaDescripcion, user_email: user.email, resuelta: false }]);
                if (insertError) throw insertError;
                
                if (nuevoStatus !== viaActualModal.status) {
                    const { error: updateError } = await supabase.from('vias').update({ status: nuevoStatus }).eq('id', idVia);
                    if (updateError) throw updateError;
                    await cargarVias();
                }
                
                mostrarNotificacion('Tarea agregada con éxito!');
                await cargarNovedadesModal();
                document.getElementById('descripcion-novedad').value = '';
            } catch (error) {
                console.error('Error al guardar:', error);
                mostrarNotificacion('Error al guardar la tarea.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Guardar';
            }
        }

        function filtrarVias() {
            const textoBusqueda = searchBox.value.toLowerCase();
            document.querySelectorAll('.grupo-vias').forEach(grupo => {
                let viasVisibles = 0;
                const viasEnGrupo = grupo.querySelectorAll('.via-box');
                viasEnGrupo.forEach(via => {
                    const coincideBusqueda = via.textContent.includes(textoBusqueda);
                    const coincideFiltro = (filtroActivo === 'todos') || (via.dataset.viaStatus === filtroActivo);
                    if (coincideBusqueda && coincideFiltro) {
                        via.style.display = 'block';
                        viasVisibles++;
                    } else {
                        via.style.display = 'none';
                    }
                });
                const mensajeVacio = grupo.querySelector('.no-results-message');
                mensajeVacio.style.display = viasVisibles === 0 ? 'block' : 'none';
            });
        }
        
        function escucharCambiosVias() {
            if (canalVias) return;
            canalVias = supabase.channel('cambios-db-vias')
                .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
                    if (payload.table === 'vias' || payload.table === 'novedades') {
                        console.log('Cambio detectado por el listener:', payload.table);
                        cargarVias();
                        if (modal.style.display === 'block' && viaActualModal) {
                            cargarNovedadesModal();
                        }
                    }
                })
                .subscribe();
        }

        // --- MANEJO DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('footer-year').textContent = new Date().getFullYear();

            checkUser();
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            closeButton.addEventListener('click', cerrarModal);
            window.addEventListener('click', (event) => { if (event.target == modal) { cerrarModal(); } });
            formNovedad.addEventListener('submit', manejarSubmitNovedad);
            searchBox.addEventListener('input', filtrarVias);
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    filtroActivo = button.id.replace('filter-', '');
                    filtrarVias();
                });
            });
            document.getElementById('tab-pendientes').addEventListener('click', (e) => {
                document.getElementById('content-pendientes').classList.add('active');
                document.getElementById('content-historial').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('tab-historial').classList.remove('active');
            });
            document.getElementById('tab-historial').addEventListener('click', (e) => {
                document.getElementById('content-historial').classList.add('active');
                document.getElementById('content-pendientes').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('tab-pendientes').classList.remove('active');
            });
            document.getElementById('historial-search').addEventListener('input', () => cargarNovedadesModal(1));
            document.getElementById('historial-date-picker').addEventListener('change', () => cargarNovedadesModal(1));
            document.querySelector('.tasks-section').addEventListener('click', async (e) => {
                const target = e.target;
                const itemLi = target.closest('li');
                if (!itemLi) return;
                const novedadId = itemLi.dataset.novedadId;
                if (target.classList.contains('btn-resolver')) {
                    if (confirm("¿Marcar esta tarea como resuelta?")) {
                        await resolverNovedad(novedadId);
                    }
                } else if (target.classList.contains('btn-eliminar')) {
                    await manejarEliminarNovedad(novedadId);
                } else if (target.classList.contains('btn-editar')) {
                    mostrarEditorNovedad(itemLi);
                } else if (target.classList.contains('btn-guardar-edicion')) {
                    await guardarEdicionNovedad(itemLi, novedadId);
                } else if (target.classList.contains('btn-cancelar-edicion')) {
                    await cargarNovedadesModal();
                }
            });
        });
    </script>
</body>
</html>
